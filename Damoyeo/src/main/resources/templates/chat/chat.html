<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Multi-Room Chat</title>
    <link rel="stylesheet" href="../css/navfooter.css"></link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.2/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #room-selection {
            margin-top: 30px;
            margin-bottom: 20px;
        }
        #messageArea {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<!-- 네비게이션 바 포함 -->
<div th:replace="~{topnav.html}"></div>

<!-- 방 선택 -->
<div id="room-selection">
    <label for="roomSelect">채팅방 선택:</label>
    <select id="roomSelect" onchange="switchRoom()">
        <option value="room1">1번 방</option>
        <option value="room2">2번 방</option>
        <option value="room3">3번 방</option>
    </select>
</div>

<!-- 채팅방 -->
<div id="chat-room">
    <ul id="messageArea"></ul>
    <input type="text" id="message" placeholder="메세지를 입력해주세요"/>
    <button onclick="sendMessage()">전송하기</button>
</div>

<script type="text/javascript" th:inline="javascript">
    var stompClient = null;
    var username = /*[[${session.userNickName}]]*/ "";
    var currentRoom = 'room1'; // 기본 방

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame); // 연결 로그 추가

            // 각 방마다 별도의 구독 설정
            stompClient.subscribe('/topic/chat/room1', function (message) {
                console.log('Received message in room1: ', message); // 메시지 수신 로그 추가
                showMessage(JSON.parse(message.body), 'room1');
            });
            stompClient.subscribe('/topic/chat/room2', function (message) {
                console.log('Received message in room2: ', message);
                showMessage(JSON.parse(message.body), 'room2');
            });
            stompClient.subscribe('/topic/chat/room3', function (message) {
                console.log('Received message in room3: ', message);
                showMessage(JSON.parse(message.body), 'room3');
            });

            // 초기 방 입장 메시지
            sendJoinMessage(currentRoom);
        }, function(error) {
            console.log('Connection error: ', error); // 연결 에러 로그 추가
        });
    }

    function sendJoinMessage(roomId) {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat.addUser/" + roomId, {}, JSON.stringify({
                sender: username,
                type: 'JOIN',
                roomId: roomId
            }));
        }
    }

    function sendMessage() {
        var messageContent = document.getElementById("message").value.trim();
        if (messageContent && stompClient) {
            var chatMessage = {
                sender: username,
                content: messageContent,
                type: 'CHAT',
                roomId: currentRoom
            };
            console.log('Sending message: ', chatMessage); // 전송 메시지 로그 추가
            stompClient.send("/app/chat.sendMessage/" + currentRoom, {}, JSON.stringify(chatMessage));
            document.getElementById("message").value = ''; // 입력 창 비우기
        }
    }

    // 방 변경 함수
    function switchRoom() {
        var roomSelect = document.getElementById('roomSelect');
        var newRoom = roomSelect.value;

        // 이전 방 나가기 메시지 전송
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat.leaveRoom", {}, JSON.stringify({
                sender: username,
                type: 'LEAVE',
                roomId: currentRoom
            }));
        }

        // 메시지 영역 초기화
        document.getElementById('messageArea').innerHTML = '';

        // 새 방 입장
        currentRoom = newRoom;
        sendJoinMessage(currentRoom);
    }

    // 메시지 표시 함수 (특정 방 전용)
    function showMessage(message, roomId) {
        // 현재 선택된 방의 메시지만 표시
        if (roomId === currentRoom) {
            var messageArea = document.getElementById("messageArea");
            var messageElement = document.createElement('li');

            if (message.type === 'JOIN') {
                messageElement.classList.add('event-message');
                messageElement.innerHTML = message.sender + ' joined the room!';
            } else if (message.type === 'LEAVE') {
                messageElement.classList.add('event-message');
                messageElement.innerHTML = message.sender + ' left the room!';
            } else if (message.type === 'CHAT') {
                messageElement.innerHTML = message.sender + ": " + message.content;
            }
            messageArea.appendChild(messageElement);

            // 스크롤을 최신 메시지로 자동 이동
            messageArea.scrollTop = messageArea.scrollHeight;
        }
    }

    // 페이지 로드 시 연결
    window.onload = function () {
        connect();
    };
</script>

<!-- 푸터 포함 -->
<div th:replace="~{footer.html}"></div>
</body>
</html>